# 函数fcntl

函数fcntl可以改变已打开的文件的性质。

```c
#include <fcntl.h>
int fcntl(int filedes, int cmd, .../* int arg */);
```

* 出错返回-1。
* cmd
	* 复制一个现有的描述符(`cmd=F_DUPFD` `cmd=F_DUPFD_CLOEXEC`)。
	* 获得/设置文件描述符标记(`cmd=F_GETFD` `cmd=F_SETFD`)。
	* 获得/设置文件状态标志(`cmd=F_GETFL` `cmd=F_SETFL`)。
	* 获得/设置异步I/O所有权(`cmd=F_GETOWN` `cmd=f_SETOWN`)。
	* 获得/设置记录锁(`cmd=F_GETLK` `cmd=F_SETLK` `cmd=F_SETLKW`)。

`F_DUPFD` 复制文件描述符filedes。新文件描述符作为函数的返回值。它是尚未打开的各描述符中大于或等于第三个参数值中各值的最小值。新描述符与filedes共享同一文件表项，但是它有自己的一套文件描述符标志，其`FD_CLOEXEC`文件描述符被清除。

`F_GETFD` 对应于filedes的文件描述符标志作为函数值返回。当前只定义了一个文件描述符标志`FD_CLOEXEC`。

`F_SETFD` 对于filedes设置文件描述符标志。设置为第三个参数值(整型值)。

`F_GETFL` 对应于filedes的文件状态标志作为函数值返回。

file status flag | Description
--- | ---
O\_RDONLY | 只读打开
O\_WRONLY | 只写打开
O\_RDWR | 读写打开
O\_EXEC | 只执行打开
O\_SEARCH | 打开目录以搜索
O\_APPEND | 追加打开方式
O\_NONBLOCK | 非阻塞模式
O\_SYNC | 等待写完成(数据和属性)
O\_DSYNC | 等待写完成(仅数据)
O\_RSYNC | 同步读和写
O\_FSYNC | 等待写完成(FreeBSD与MacOS)
O\_ASYNC | 异步I/O(FreeBSD与MacOS)

前5个参数需要使用屏蔽字`O_ACCMODE`取得访问位，然后与他们进行比较。

`F_SETFL` 将文件状态标志设置为第三个参数值(整型)，可更改的标志为`O_APPEND` `O_NONBLOCK` `O_SYNC` `O_DSYNC` `O_RSYNC` `O_FSYNC` `O_ASYNC`。

`F_GETOWN` 取当前接收SIGIO和SIGURG信号的进程ID或进程组ID。

`F_SETOWN` 设置接收SIGIO和SIGURG信号的进程ID和进程组ID。正arg指定一个进程ID，负的arg表示等于arg绝对值的一个进程组ID。

在修改文件描述符标志和文件状态标志的时候，先要取得现有的标志值，然后根据需要修改它，最后设置新标志值。
